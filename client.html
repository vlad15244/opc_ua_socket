<!-- opcua.html -->
<!DOCTYPE html>
<html>
<head>
    <title>OPC UA Real-time Data</title>
    <style>
        #data-display {
            padding: 20px;
            border: 1px solid #ccc;
            margin: 20px;
        }
    </style>

   <h3>Управление ПЛК</h3>
    <label>
        Значение: <input type="number" id="control-value" value="0" step="0.1">
    </label>
        <button onclick="sendCommand()">Отправить</button>
        <div id="status"></div>
</head>
<button onclick="callAdd()">Добавить значение + 5</button>
    <div id="myTextField" style="padding: 10px; border: 1px solid #ddd;">
        Здесь появится текст
    </div>
<button onclick="Toogle()">Вкл/выкл нагрев</button>
<body>
    <h1>Данные OPC UA в реальном времени</h1>
    <div id="data-display">
        <p>Загрузка данных</p>
    </div>

    <script>
        const socket = new WebSocket('ws://localhost:8765');
        const display = document.getElementById('data-display');
        const textField = document.getElementById('myTextField'); 

        socket.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                const text_val = data.value5;

                function updateText(VALUE) {
                    // Имитируем получение значения
                    const textField = document.getElementById('myTextField');

                    if (VALUE === 1) {
                        textField.textContent = 'Нагрев включен';
                    } else if (VALUE === 2) {
                        textField.textContent = 'Пауза ';
                    } else {
                        textField.textContent = 'Нагрев выключен';
                    }
                }

                // Сразу показываем текст при загрузке
                updateText(text_val);

                display.innerHTML = `
                    <p>PV Зона 1: ${data.PV1}</p>
                    <p>PV Зона 2: ${data.PV2}</p>  
                    <p>PV Зона 3: ${data.PV3}</p> 
                    <p>PV Зона 4: ${data.PV4}</p>    
                    <p>SP Зона 1: ${data.SP1}</p>
                    <p>SP Зона 2: ${data.SP2}</p>  
                    <p>SP Зона 3: ${data.SP3}</p> 
                    <p>SP Зона 4: ${data.SP4}</p>                                                                     
                `;
      
            } catch (error) {
                console.error('Ошибка обработки данных:', error);
            }
        };




        /*socket.onopen = function(event) {
            try {
                const data = JSON.parse(event.data);
                display.innerHTML = `
                    <p>Значение: ${data.value}</p>
                    <p>Время: ${data.timestamp}</p>
                `;
            } catch (error) {
                console.error('Ошибка обработки данных:', error);
            }
        };*/



        socket.onerror = function(error) {
            // Создаем элемент для отображения ошибки
            const errorElement = document.createElement('div');
            errorElement.classList.add('error-message');
            
            // Форматируем вывод ошибки
            const errorMessage = `
                <h3>Произошла ошибка:</h3>
                <p>Код ошибки: ${error.code}</p>
                <p>Сообщение: ${error.message}</p>
                <p>Причина: ${error.reason}</p>
            `;
            
            errorElement.innerHTML = errorMessage;
            display.innerHTML = ''; // Очищаем предыдущий контент
            display.appendChild(errorElement);
        };
        
        function sendCommand() {
        const valueInput = document.getElementById('control-value');
        const command = {
            action: "write",
            value: parseFloat(valueInput.value)
        }
            socket.send(JSON.stringify(command));
        }

        function callAdd() {
        const command = {
            action: "rcm"
        }
            socket.send(JSON.stringify(command));
        }        
        function Toogle() {
        const command = {
            action: "set_point"
        }
            socket.send(JSON.stringify(command));
        }         
    </script>
    
</body>
</html>
